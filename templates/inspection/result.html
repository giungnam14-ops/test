{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 animate-fade-in">
    <div>
        <h2 class="fw-bold mb-0">AI ì‹¬ì¸µ êµ¬ì¡° ë¶„ì„ ë¦¬í¬íŠ¸</h2>
        <p class="text-secondary">#{{ result['id'] }} | {{ result['analyzed_at'] }} | {{ result['building_name'] }}</p>
    </div>
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary rounded-pill">
        &larr; ëŒ€ì‹œë³´ë“œ
    </a>
</div>

<div class="row animate-fade-in" style="animation-delay: 0.1s;">
    <!-- ì™¼ìª½: ì‹œê°í™” ì´ë¯¸ì§€ -->
    <div class="col-lg-5 mb-4">
        <div class="glass-card h-100 overflow-hidden">
            <div class="card-header bg-transparent fw-bold border-bottom">ğŸ” ê· ì—´ íƒì§€ ì‹œê°í™” (Visual Overlay)</div>
            <div class="position-relative"
                style="background: #000; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                <!-- Processed Image if available, else Original -->
                {% if result['processed_image_path'] %}
                <img src="{{ url_for('static', filename=result['processed_image_path']) }}" class="img-fluid"
                    style="max-height: 500px;" alt="Processed Analysis">
                {% else %}
                <img src="{{ url_for('static', filename=result['image_path']) }}" class="img-fluid"
                    style="max-height: 500px;" alt="Original Image">
                {% endif %}
                <div
                    class="position-absolute bottom-0 start-0 w-100 bg-dark bg-opacity-75 text-white p-2 text-center small">
                    <span class="text-danger">Red Line</span>: Detected Crack Contours
                </div>
            </div>

            <!-- Radar Chart -->
            <div class="p-4 bg-white">
                <h6 class="text-center text-uppercase fw-bold text-secondary mb-3">ì•ˆì „ ì§€í‘œ ë¶„ì„ (Safety Metrics)</h6>
                <canvas id="safetyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: í…ìŠ¤íŠ¸ ë¶„ì„ -->
    <div class="col-lg-7 mb-4">
        <div class="glass-card p-4 h-100">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h5 class="text-secondary text-uppercase fs-6 ls-1 mb-1">Risk Assessment</h5>
                    <h1 class="display-5 fw-bold risk-{{ result['risk_level']|lower }}">{{ result['risk_level'] }}</h1>
                </div>
                <div class="text-end">
                    <div class="display-6 fw-bold">{{ result['crack_score'] }}</div>
                    <small class="text-muted">Severity Score</small>
                </div>
            </div>

            <hr class="opacity-25 my-4">

            <div class="mb-4">
                <h5 class="fw-bold mb-3">ğŸ—ï¸ êµ¬ì¡°ì  ì•ˆì •ì„± & ê³µë²• ë¶„ì„</h5>
                <!-- Construction Method -->
                <div class="d-flex align-items-center mb-3">
                    <span class="badge bg-primary me-2">ê³µë²• ì¶”ì •</span>
                    <span class="fw-bold">{{ result['construction_method'] }}</span>
                    {% if result['construction_year'] %}
                    <span class="text-muted ms-2">({{ result['construction_year'] }}ë…„ ì¤€ê³µ)</span>
                    {% endif %}
                </div>

                <!-- Generative Stability Text (Markdown-like rendering handled by plain text for MVP) -->
                <div class="p-4 bg-light rounded-3 border border-light"
                    style="white-space: pre-line; line-height: 1.8;">
                    {{ result['structural_stability'] }}
                </div>
            </div>

            <div class="mb-4">
                <h6 class="text-uppercase text-danger fw-bold small mb-2">âš¡ ë‚´ë¶€ ìœ„í—˜ ë° ì„¤ë¹„ ì§„ë‹¨ (Internal Risks)</h6>
                <ul class="list-group list-group-flush rounded-3">
                    {% for risk in internal_risks %}
                    <li
                        class="list-group-item d-flex justify-content-between align-items-center bg-danger bg-opacity-10 text-danger border-danger border-opacity-25">
                        <span>{{ risk }}</span>
                        {% if 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ' in risk %}
                        <span class="badge bg-success rounded-pill">Safe</span>
                        {% else %}
                        <span class="badge bg-danger rounded-pill">Warning</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <hr class="opacity-25 my-4">

            <div class="mb-4">
                <h5 class="fw-bold mb-3">ğŸ“‘ êµ¬ì¡° ë° ì•ˆì „ ì§„ë‹¨ ì „ë¬¸ê°€ ë¦¬í¬íŠ¸</h5>

                <ul class="nav nav-pills mb-3 nav-fill" id="expertTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active rounded-pill fw-bold" id="diagnosis-tab" data-bs-toggle="pill"
                            data-bs-target="#diagnosis" type="button" role="tab" aria-selected="true">ğŸ©º ì •ë°€ ì§„ë‹¨</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link rounded-pill fw-bold" id="causes-tab" data-bs-toggle="pill"
                            data-bs-target="#causes" type="button" role="tab" aria-selected="false">ğŸ” ì›ì¸ ë¶„ì„</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link rounded-pill fw-bold" id="repairs-tab" data-bs-toggle="pill"
                            data-bs-target="#repairs" type="button" role="tab" aria-selected="false">ğŸ›  ë³´ìˆ˜ ëŒ€ì±…</button>
                    </li>
                </ul>

                <div class="tab-content" id="expertTabContent">
                    <!-- Diagnosis Tab -->
                    <div class="tab-pane fade show active" id="diagnosis" role="tabpanel">
                        <div class="glass-card p-3 border-start border-4 border-primary">
                            <h6 class="fw-bold text-primary">{{ expert_report['diagnosis']['title'] }}</h6>
                            <ul class="mb-0 small text-secondary" style="line-height: 1.8;">
                                {% for item in expert_report['diagnosis']['content'] %}
                                <li>{{ item }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Causes Tab -->
                    <div class="tab-pane fade" id="causes" role="tabpanel">
                        <div class="glass-card p-3 border-start border-4 border-warning">
                            <h6 class="fw-bold text-warning">{{ expert_report['causes']['title'] }}</h6>
                            <ul class="mb-0 small text-secondary" style="line-height: 1.8;">
                                {% for item in expert_report['causes']['content'] %}
                                <li>{{ item }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Repairs Tab -->
                    <div class="tab-pane fade" id="repairs" role="tabpanel">
                        <div class="glass-card p-3 border-start border-4 border-success">
                            <h6 class="fw-bold text-success">{{ expert_report['repairs']['title'] }}</h6>
                            <ul class="mb-0 small text-secondary" style="line-height: 1.8;">
                                {% for item in expert_report['repairs']['content'] %}
                                <li class="mb-2">{{ item|safe }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="opacity-25 my-4">

            <form action="{{ url_for('report.approve_analysis') }}" method="post">
                <input type="hidden" name="analysis_id" value="{{ result['id'] }}">
                <div class="mb-3">
                    <label for="summary" class="form-label fw-bold small">ìµœì¢… ìŠ¹ì¸ ë° ì½”ë©˜íŠ¸</label>
                    <textarea class="form-control" name="summary" id="summary" rows="2"
                        placeholder="ì „ë¬¸ê°€ ì˜ê²¬ì„ ì¶”ê°€í•˜ì„¸ìš”..."></textarea>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary rounded-pill fw-bold shadow-sm py-2">
                        âœ… ì´ ë¶„ì„ ê²°ê³¼ ìŠ¹ì¸ (Approve)
                    </button>
                    <a href="{{ url_for('inspection.new_inspection') }}" class="btn btn-outline-secondary rounded-pill">
                        â†º ë‹¤ì‹œ ì ê²€í•˜ê¸°
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('safetyChart').getContext('2d');
    const chartData = {{ chart_data | tojson }};

    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['êµ¬ì¡° ì•ˆì „ì„±', 'ë‚´êµ¬ì„±', 'ì„¤ê³„ í’ˆì§ˆ', 'ê¸°ì´ˆ ì•ˆì •ì„±', 'ìœ ì§€ê´€ë¦¬'],
            datasets: [{
                label: 'AI í‰ê°€ ì ìˆ˜',
                data: [
                    chartData.safety || 0,
                    chartData.durability || 0,
                    chartData.design || 0,
                    chartData.foundation || 0,
                    chartData.maintenance || 0
                ],
                fill: true,
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderColor: 'rgb(59, 130, 246)',
                pointBackgroundColor: 'rgb(59, 130, 246)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(59, 130, 246)'
            }]
        },
        options: {
            scales: {
                r: {
                    angleLines: { display: false },
                    suggestedMin: 0,
                    suggestedMax: 100
                }
            }
        }
    });
</script>
{% endblock %}