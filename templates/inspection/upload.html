{% extends "base.html" %}

{% block content %}
<div class="row animate-fade-in">
    <div class="col-md-8 mx-auto">
        <div class="glass-card p-4">
            <h2 class="mb-4 fw-bold text-center text-white">AI ì•ˆì „ ì ê²€ (Auto-Lookup)</h2>

            <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active rounded-pill text-white" id="pills-auto-tab" data-bs-toggle="pill"
                        data-bs-target="#pills-auto" type="button" role="tab">ğŸ” ê±´ë¬¼ ê²€ìƒ‰ & ì ê²€</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link rounded-pill text-white" id="pills-manual-tab" data-bs-toggle="pill"
                        data-bs-target="#pills-manual" type="button" role="tab">ğŸ¢ ê¸°ì¡´ ê±´ë¬¼ ì„ íƒ</button>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <!-- 1. Auto Lookup Tab -->
                <div class="tab-pane fade show active" id="pills-auto" role="tabpanel">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control form-control-lg" id="searchQuery"
                            placeholder="ê±´ë¬¼ ì´ë¦„ (ì˜ˆ: ë¡¯ë°ì›”ë“œíƒ€ì›Œ, 63ë¹Œë”©)">
                        <button class="btn btn-primary" type="button" onclick="searchBuilding()">ê²€ìƒ‰</button>
                    </div>

                    <div id="searchResult" class="d-none border rounded p-3 mb-3"
                        style="background: rgba(255,255,255,0.05);">
                        <div class="d-flex align-items-center mb-2">
                            <img id="resultImage" src="" class="rounded me-3" width="80" height="80"
                                style="object-fit: cover;">
                            <div class="flex-grow-1">
                                <h5 id="resultName" class="fw-bold mb-1 text-white"></h5>
                                <p id="resultInfo" class="mb-0 small text-secondary"></p>
                            </div>
                        </div>
                        <button type="button" class="btn btn-success w-100 btn-sm fw-bold"
                            onclick="document.getElementById('autoForm').submit()">
                            âœ… ìœ„ ê²€ìƒ‰ëœ ê±´ë¬¼/ì´ë¯¸ì§€ë¡œ ì¦‰ì‹œ ë¶„ì„í•˜ê¸°
                        </button>
                    </div>

                    <form action="{{ url_for('inspection.process_inspection') }}" method="post"
                        enctype="multipart/form-data" id="autoForm">
                        <input type="hidden" name="building_name" id="formBuildName">
                        <input type="hidden" name="building_location" id="formBuildLoc">
                        <input type="hidden" name="building_usage" id="formBuildUsage">
                        <input type="hidden" name="building_year" id="formBuildYear">
                        <input type="hidden" name="image_url" id="formImageUrl">

                        <div class="mb-3" id="fileUploadContainer">
                            <label for="fileAuto" class="form-label fw-bold text-white">ë˜ëŠ” ì§ì ‘ ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
                            <input type="file" class="form-control" id="fileAuto" name="file"
                                accept=".jpg, .jpeg, .png">
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-2 rounded-pill fw-bold"
                            id="btnMainSubmit">ğŸš€ AI ì‹¬ì¸µ ë¶„ì„ ì‹œì‘</button>
                    </form>
                </div>

                <!-- 2. Manual Select Tab -->
                <div class="tab-pane fade" id="pills-manual" role="tabpanel">
                    <form action="{{ url_for('inspection.process_inspection') }}" method="post"
                        enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="building_id" class="form-label">ì ê²€ ëŒ€ìƒ ê±´ì¶•ë¬¼ ì„ íƒ</label>
                            <select class="form-select" name="building_id" id="building_id">
                                <option value="" selected disabled>ëª©ë¡ì—ì„œ ì„ íƒí•˜ì„¸ìš”</option>
                                {% for b in buildings %}
                                <option value="{{ b['id'] }}">{{ b['name'] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="file" class="form-label">ì ê²€ìš© ì´ë¯¸ì§€</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".jpg, .jpeg, .png">
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-2 rounded-pill">AI ë¶„ì„ ì‹œì‘</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function searchBuilding() {
        const query = document.getElementById('searchQuery').value;
        if (!query) return alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”");

        const btn = event.target;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ê²€ìƒ‰ ì¤‘...`;

        try {
            const response = await fetch('/inspection/search_building', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });
            const res = await response.json();

            if (res.success) {
                const data = res.data;
                document.getElementById('searchResult').classList.remove('d-none');
                document.getElementById('resultImage').src = data.image_url;
                document.getElementById('resultName').innerText = data.name;
                document.getElementById('resultInfo').innerText = `${data.data.location} | ${data.data.construction_year}ë…„ ì¤€ê³µ | ${data.data.method}`;

                // Fill Hidden Form
                document.getElementById('formBuildName').value = data.name;
                document.getElementById('formBuildLoc').value = data.data.location;
                document.getElementById('formBuildUsage').value = data.data.usage;
                document.getElementById('formBuildYear').value = data.data.construction_year;
            } else {
                alert(res.message);
            }
        } catch (e) {
            console.error(e);
            alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            btn.innerText = "ê²€ìƒ‰";
        }
    }

    // Simple JS to fix syntax (Since I wrote 'async def' which is pythonic mixup, fixing to 'async function')
    // But wait, I am writing to file, so I will correct it in the file content below properly.
</script>
<script>
    async function searchBuilding() {
        const query = document.getElementById('searchQuery').value;
        if (!query) return alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”");

        const btn = document.querySelector('#pills-auto button.btn-primary'); // Select the search button correctly or use event.target carefully
        const originalText = btn.innerText;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ê²€ìƒ‰ ì¤‘...`;

        try {
            const response = await fetch('/inspection/search_building', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });
            const res = await response.json();

            if (res.success) {
                const data = res.data;
                document.getElementById('searchResult').classList.remove('d-none');
                document.getElementById('resultImage').src = data.image_url;
                document.getElementById('resultName').innerText = data.name;
                document.getElementById('resultInfo').innerText = `${data.data.location} | ${data.data.construction_year}ë…„ ì¤€ê³µ | ${data.data.method}`;

                // Fill Hidden Form
                document.getElementById('formBuildName').value = data.name;
                document.getElementById('formBuildLoc').value = data.data.location;
                document.getElementById('formBuildUsage').value = data.data.usage;
                document.getElementById('formBuildYear').value = data.data.construction_year;

                if (data.image_url) {
                    document.getElementById('formImageUrl').value = data.image_url;
                    // Hide file upload if found, to focus on the "Analyze" button in the card
                    document.getElementById('fileUploadContainer').style.opacity = '0.5';
                    document.getElementById('btnMainSubmit').innerText = "ğŸš€ AI ì‹¬ì¸µ ë¶„ì„ ì‹œì‘ (ì—…ë¡œë“œ íŒŒì¼ ìš°ì„ )";
                }
            } else {
                alert(res.message);
            }
        } catch (e) {
            console.error(e);
            alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            btn.innerText = "ê²€ìƒ‰";
        }
    }
</script>
{% endblock %}